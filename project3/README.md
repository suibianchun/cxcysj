**Project3: implement length extension attack for SM3, SHA256, etc**

我选择的是对SM3算法进行长度拓展攻击

**攻击原理**

对SM3进行长度拓展攻击的原理基于哈希函数的长度拓展特性和消息扩展函数的漏洞。SM3是一种长度预处理算法，其输入是由消息分组和初始状态向量组成的。攻击者利用消息扩展函数在输入中添加恶意数据，通过构造特定的输入来伪造有效的哈希结果。

具体攻击过程如下：

1、首先，攻击者需要获取原始消息的摘要值，即已知的哈希结果H0。这可以通过合法方式获得，例如通过公开的哈希值或其他手段。

2、接下来，攻击者准备一个自定义的消息前缀P，以及一个扩展消息Q。攻击的目标是构造一个新的输入，使得哈希结果为想要的值H1。

3、攻击者首先找到满足以下条件的合适的初始状态向量V：

V 是一个有效的状态向量。

通过修改V的某些部分，可以使SM3哈希的中间状态与所需的哈希结果H1一致。

4、接着，攻击者计算消息Q的长度，并根据消息扩展函数的漏洞，构造一个恶意的消息扩展字W'。该字应满足以下条件：

使得扩展后的消息字W满足SM3算法的填充要求。

使得V经过一系列轮函数后，与恶意扩展消息字W'得到的中间状态与H1一致。

5、最后，攻击者构造假的输入，将前缀P、原始消息扩展字Bi以及恶意的扩展消息字W'组合在一起，作为新的输入。对这个新的输入进行SM3哈希计算，得到的哈希结果即为H1。

**原理图**

![image](https://github.com/suibianchun/cxcysj/assets/138552183/005aeccc-a73c-4104-8cff-23cea36e307f)

**代码思路**

介绍核心几个函数：

**压缩函数CF(V, Bi)：**

将输入的当前哈希值V和输入消息块Bi进行一轮压缩操作。在每一轮压缩操作中，根据定义的步骤和公式，进行一系列位运算和循环左移操作，最终更新哈希值。返回压缩后的新的哈希值。

**函数SM3(plaintext)：**

根据传入的明文字符串进行SM3哈希计算。首先计算需要填充的位数和填充的内容，然后将明文字符串进行补齐和拼接，得到整个消息。将消息分成多个块，并依次调用压缩函数对每个块进行压缩操作，并更新哈希值。最终返回哈希结果。

**函数SM3_len_exten_attack(num_block, IV, plaintext)：**

进行长度扩展攻击。基于原始消息哈希值、初始向量（IV）和明文字符串，构造一组新的消息块，并调用压缩函数进行压缩操作。返回攻击后的哈希值。

**函数verify_len_extension_attack(num_block, IV2, add)：**

验证长度扩展攻击的结果是否正确。根据原始消息的哈希值和攻击所需要的块数，构造新的明文字符串，调用SM3()和SM3_len_exten_attack()计算原始哈希值和攻击后哈希值。
比较两个哈希值是否相等，如果相等则返回哈希值和攻击成功的提示，否则返回攻击失败的提示。

**运行结果**

![image](https://github.com/suibianchun/cxcysj/assets/138552183/72693fe9-7928-43ab-975e-bea970e16299)





